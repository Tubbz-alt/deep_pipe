import dpipe.commands as commands
from dpipe.config import if_missing, run
from dpipe.io import ConsoleArguments, load_json
from dpipe.experiment.flat.base import flat
from dpipe.train.base import train as train_base
from dpipe.train.logging import TBLogger
from dpipe.train.validator import validate

console = ConsoleArguments()

train_ids = load_json('train_ids.json')
val_ids = load_json('val_ids.json')
test_ids = load_json('test_ids.json')

saved_model_path = 'model.pth'

build_experiment = flat(
    config_path=console.config_path,
    experiment_path=console.experiment_path,
    split=split
)

train = train_base(
    do_train_step=model.do_train_step,
    batch_iter=batch_iter,
    n_epochs=n_epochs,
    logger=logger,
    lr_policy=lr_policy,
    validate=validate_step
)

train_model = lambda save_model_path: run(train, model.save(save_model_path))

log_path = 'train_logs'
val_metrics = None
logger = TBLogger(log_path=log_path)

validate_step = validate(
    # partial
    load_x=load_x,
    load_y=load_y,
    ids=val_ids,
    metrics=val_metrics,
    validate_fn=validate_fn
)

predict = lambda ids, output_path: commands.predict(
    ids=ids,
    output_path=output_path,
    load_x=load_x,
    predict_fn=predict_fn,
)

test_predictions_path = 'test_predictions'

run_train_predict = run_experiment = (
    if_missing(train_model, save_model_path=saved_model_path),
    if_missing(predict(  # partial
        ids=test_ids
    ), output_path=test_predictions_path)
)
